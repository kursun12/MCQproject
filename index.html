<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MCQ Practice v2025.09</title>
<!--
README
------
This is a client-side Multiple Choice Question (MCQ) practice tool.

Loading Questions
- Click "Load Questions" and choose a CSV or JSON file.
  - CSV format columns can appear in any order: Question, Option A..Z, Correct Answer, Explanation.
    - Correct Answer may be letters or numbers separated by comma, semicolon, pipe, slash or whitespace ("B;D", "2 4").
  - JSON format: array of objects with keys {id?, question, options, answer, explanation}.
    - answer can be a number or an array of indices (0-based or 1-based).
- A small demo dataset is included (see bottom of file) and is loaded automatically if no file is provided.

Multi-Answer Detection
  - Answers are normalized to sorted arrays of 0-based option indices.
  - If an answer array contains more than one index, the question is treated as multi-select and rendered with checkboxes and a "Select all that apply" notice.
  - Single-answer questions use radio buttons.

Session Persistence
- Progress, selected answers, and settings are stored in localStorage under the key "mcq-state".
- On page load the app attempts to resume the previous session.
- Use the "Reset" button to clear stored data.

Exporting Results/State
- After finishing the quiz you can export the results as CSV.
- The full application state (questions, answers, settings) can be exported and later imported to resume on another machine.

Timer & Utilities
- Optional overall timer: set a limit (minutes) before starting; progress auto-stops at time limit.
- Bookmark questions with the ‚òÜ button and review them later.
- Use the search box to jump to a question containing specific text.
- Questions may include optional tags. Use the tag dropdown to filter the deck or the üè∑Ô∏è button to add your own tags.
- End screen shows basic analytics: average time per question, accuracy by tag and hardest questions.
-->
<style>
/* Design System */
:root{
  /* Colors */
  --color-bg:#ffffff;
  --color-surface:#f7f8fa;
  --color-text:#1f2328;
  --color-muted:#6b7280;
  --color-accent:#2563eb;
  --color-correct:#16a34a;
  --color-incorrect:#dc2626;
  /* Radii, shadows, spacing */
  --radius:12px;
  --shadow:0 6px 18px rgba(0,0,0,.08);
  --gap:12px;
  /* Type scale */
  --font-size-sm:12px;
  --font-size-md:14px;
  --font-size-lg:16px;
  --font-size-xl:20px;
}
@media (prefers-color-scheme: dark){
  :root{
    --color-bg:#0f172a;
    --color-surface:#111827;
    --color-text:#e5e7eb;
    --color-muted:#94a3b8;
    --color-accent:#60a5fa;
    --color-correct:#22c55e;
    --color-incorrect:#ef4444;
  }
}
body.dark{
  --color-bg:#0f172a;
  --color-surface:#111827;
  --color-text:#e5e7eb;
  --color-muted:#94a3b8;
  --color-accent:#60a5fa;
  --color-correct:#22c55e;
  --color-incorrect:#ef4444;
}
/* Legacy var aliases (keep existing logic working) */
:root,body.dark{
  --bg:var(--color-bg);
  --fg:var(--color-text);
  --accent:var(--color-accent);
  --correct:var(--color-correct);
  --incorrect:var(--color-incorrect);
}

/* Base */
*{box-sizing:border-box}
body{
  background:var(--color-bg);
  color:var(--color-text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
  margin:0;display:flex;flex-direction:column;min-height:100vh;
  font-size:var(--font-size-lg);
}
a{color:inherit}
button{cursor:pointer}
.hidden{display:none}

/* AppShell */
header{
  position:sticky;top:0;z-index:10;
  display:grid;grid-template-columns:1fr auto auto;gap:var(--gap);
  align-items:center;padding:10px 16px;
  background:linear-gradient(180deg,var(--color-surface),transparent),var(--color-surface);
  box-shadow:var(--shadow);
}
header h1{margin:0;font-size:18px;font-weight:700;display:flex;gap:8px;align-items:center}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(99,102,241,.15);color:#6366f1;font-weight:600;font-size:12px}
.bar{height:8px;background:rgba(148,163,184,.35);border-radius:999px;overflow:hidden}
.bar>div{height:100%;width:0;background:var(--color-accent);transition:width .25s ease}
.shell-right{display:flex;align-items:center;gap:8px;justify-self:end}
.icon-btn{border:1px solid rgba(148,163,184,.35);background:transparent;color:var(--color-text);padding:6px 10px;border-radius:8px}
.icon-btn[aria-pressed="true"]{border-color:var(--color-accent);color:var(--color-accent)}
.score-pill{padding:4px 8px;border-radius:999px;background:rgba(34,197,94,.15);color:#16a34a;font-weight:700}

/* Layout */
main{flex:1;display:grid;grid-template-columns:260px 1fr;gap:var(--gap);padding:16px;max-width:1200px;margin:0 auto;width:100%}
aside#sidebar{background:var(--color-surface);border:1px solid rgba(148,163,184,.25);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
.content{display:flex;flex-direction:column;gap:var(--gap)}

/* Card */
.card{background:var(--color-surface);border:1px solid rgba(148,163,184,.25);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
.question{font-size:18px;line-height:1.55;margin:0 0 8px}
.muted{color:var(--color-muted)}

/* Options */
.options{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
.option{display:flex;align-items:center;gap:10px;padding:12px 14px;border:1px solid rgba(148,163,184,.35);border-radius:10px;cursor:pointer;background:var(--color-bg);transition:background .15s,border-color .15s}
.option:hover{border-color:var(--color-accent);background:rgba(37,99,235,.06)}
.option:focus{outline:2px solid var(--color-accent)}
.option.correct{border-color:var(--color-correct);background:rgba(22,163,74,.1)}
.option.incorrect{border-color:var(--color-incorrect);background:rgba(220,38,38,.08)}

/* Footer actions */
footer{position:sticky;bottom:0;background:var(--color-surface);box-shadow:var(--shadow);padding:10px 16px;display:flex;align-items:center;gap:8px}
.btn{border:1px solid rgba(148,163,184,.35);background:var(--color-bg);color:var(--color-text);padding:8px 12px;border-radius:8px}
.btn.primary{background:var(--color-accent);border-color:var(--color-accent);color:#fff}
.btn.ghost{background:transparent}
.btn:disabled{opacity:.6;cursor:not-allowed}

/* Drawers and Modals */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5)}
.modal .box{background:var(--color-surface);color:var(--color-text);padding:16px;border-radius:12px;max-width:95%;max-height:95%;overflow:auto;box-shadow:var(--shadow)}
.drawer{position:fixed;top:0;right:-360px;width:320px;height:100vh;background:var(--color-surface);box-shadow:var(--shadow);border-left:1px solid rgba(148,163,184,.3);padding:16px;transition:right .25s ease;overflow:auto;z-index:20}
.drawer.open{right:0}

/* Table */
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid rgba(148,163,184,.25);text-align:left}
th.sortable{cursor:pointer}
th.sortable:after{content:'\25B4';opacity:.35;margin-left:6px;font-size:12px}
th.sortable.desc:after{content:'\25BE'}

/* Tags/Pills */
.pills{display:flex;flex-wrap:wrap;gap:6px}
.pill{padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.35);cursor:pointer}
.pill.active{background:var(--color-accent);border-color:var(--color-accent);color:#fff}

/* Toast */
.toast-wrap{position:fixed;bottom:16px;right:16px;display:flex;flex-direction:column;gap:8px;z-index:50}
.toast{background:var(--color-surface);border:1px solid rgba(148,163,184,.35);box-shadow:var(--shadow);padding:10px 12px;border-radius:8px}

/* Responsive */
@media (max-width: 900px){
  main{grid-template-columns:1fr}
  aside#sidebar{order:2}
}
@media (max-width:600px){
  header{grid-template-columns:1fr;padding:8px 12px;row-gap:8px;}
  .shell-right{flex-wrap:wrap;gap:4px;width:100%;justify-content:flex-start;}
  main{padding:12px;}
  .drawer{width:100%;right:-100%;}
  .drawer.open{right:0;}
  .modal .box{width:90%;max-width:none;}
  .btn,.icon-btn,input,select{padding:10px 14px;}
  footer{flex-direction:column;align-items:stretch;}
}
@media (max-width:480px){
  header h1{font-size:16px;}
  .badge{font-size:10px;padding:2px 6px;}
}
@media (prefers-reduced-motion: reduce){
  *{transition:none!important}
}
</style>
</head>
<body>
<header>
  <h1>
    MCQ Practice
    <span id="mode" class="badge" title="Current mode">Practice</span>
    <span id="version" class="badge" title="UI build/version">v2025.09</span>
  </h1>
  <input type="file" id="fileInput" accept=".csv,.json" class="hidden" />
  <button id="loadBtn" class="icon-btn" title="Load CSV/JSON">üìÅ Load</button>
  <div class="shell-right">
    <div id="progressText" class="muted"></div>
    <div id="progressBar" class="bar"><div></div></div>
    <span id="score" class="score-pill">0/0</span>
    <div id="timer" class="icon-btn" aria-live="polite" title="Timer">00:00</div>
    <button id="openSettings" class="icon-btn" aria-label="Open settings">‚öô</button>
    <button id="darkToggle" class="icon-btn" aria-label="Toggle theme" title="Theme">üåô</button>
  </div>
  <a id="sampleCsvLink" download="sample.csv" class="hidden"></a>
</header>
<main aria-live="polite">
  <aside id="sidebar" aria-label="Sidebar">
    <div class="pills" style="margin-bottom:8px">
      <button class="pill" id="filterAll">All</button>
      <button class="pill" id="filterUnseen">Unseen</button>
      <button class="pill" id="filterIncorrect">Incorrect</button>
      <button class="pill" id="filterBookmarked">Bookmarked</button>
    </div>
    <input type="search" id="searchBox" placeholder="Search‚Ä¶ (press /)" aria-label="Search" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(148,163,184,.35);margin-bottom:8px" />
    <select id="tagFilter" title="Filter by tag" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(148,163,184,.35);margin-bottom:12px"><option value="">All Tags</option></select>
    <div>
      <h3 style="margin:8px 0">Bookmarks</h3>
      <ul id="bookmarkList" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px"></ul>
    </div>
  </aside>
  <section class="content">
    <div id="quiz" class="card">
      <div id="questionRow" style="display:flex;align-items:center;gap:.5rem;">
        <div id="question" class="question" style="flex:1"></div>
        <span id="multiNotice" class="badge hidden" aria-hidden="true"></span>
        <button id="tagEditBtn" class="icon-btn" title="Edit tags">üè∑Ô∏è</button>
        <button id="flagBtn" class="icon-btn" title="Bookmark question" aria-pressed="false">‚òÜ</button>
        <button id="noteBtn" class="icon-btn" title="Add note">üìù</button>
      </div>
      <div id="tagInfo" class="muted" style="margin-bottom:8px"></div>
      <ul id="options" class="options"></ul>
      <div id="feedback" aria-live="assertive" style="min-height:24px"></div>
      <details id="explainWrap" class="hidden"><summary class="muted">Show explanation</summary><div id="explanation" style="margin-top:6px"></div></details>
      <div class="muted" style="margin-top:8px">Press ? for keyboard shortcuts.</div>
    </div>
  </section>
</main>
<footer>
  <button id="submitBtn" class="btn primary">Submit</button>
  <button id="nextBtn" class="btn hidden">Next</button>
  <button id="restartBtn" class="btn ghost">Restart</button>
  <button id="exportBtn" class="btn ghost" title="Export results (CSV)">Export CSV</button>
  <button id="exportStateBtn" class="btn ghost" title="Export state (JSON)">Export State</button>
  <input type="file" id="importState" class="hidden" />
  <button id="importStateBtn" class="btn ghost">Import State</button>
</footer>

<div id="resultModal" class="modal" role="dialog" aria-modal="true">
  <div class="box">
    <h2>Results</h2>
    <div id="resultSummary" style="margin-bottom:8px"></div>
    <div id="analytics" class="card" style="margin:8px 0"></div>
    <div class="card" style="overflow:auto">
      <table id="resultTable" aria-label="Results table">
        <thead>
          <tr>
            <th class="sortable" data-key="idx">#</th>
            <th class="sortable" data-key="q">Question</th>
            <th>Yours</th>
            <th>Correct</th>
            <th class="sortable" data-key="ok">‚úì</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button id="retryBtn">Retry Incorrect</button>
    <button id="flaggedBtn">Review Flagged</button>
    <button id="closeResult">Close</button>
  </div>
</div>

<!-- Settings Drawer -->
<aside id="settingsDrawer" class="drawer" aria-label="Settings">
  <h3>Settings</h3>
  <label><input type="checkbox" id="setShuffleQ"> Shuffle questions</label><br>
  <label><input type="checkbox" id="setShuffleO"> Shuffle options</label><br>
  <label><input type="checkbox" id="setInstant"> Instant reveal on select</label><br>
  <label><input type="checkbox" id="setSounds"> Sound cues</label><br>
  <label><input type="checkbox" id="setAnims" checked> Animations</label><br>
  <label><input type="checkbox" id="setCompact"> Compact mode</label><br>
  <label>Font size
    <select id="setFont">
      <option value="sm">Small</option>
      <option value="md" selected>Medium</option>
      <option value="lg">Large</option>
      <option value="xl">X-Large</option>
    </select>
  </label><br>
  <label>Time limit (min) <input type="number" id="timeLimit" min="0" style="width:5rem"></label><br>
  <label><input type="checkbox" id="setDark"> Dark mode</label><br>
  <label><input type="checkbox" id="setPartial"> Partial credit (beta)</label><br>
  <div style="margin-top:8px">
    <button id="saveSettings" class="btn primary">Save</button>
    <button id="closeSettings" class="btn">Close</button>
  </div>
  <div style="margin-top:10px" class="muted">Press Esc to close</div>
  <hr>
  <div class="muted">Import tips: CSV columns can be in any order; JSON supports number or array answers.</div>
  <button id="openFileFromSettings" class="btn" style="margin-top:8px">üìÅ Load Questions</button>
</aside>

<!-- Keyboard Help Modal -->
<div id="keysModal" class="modal" role="dialog" aria-modal="true">
  <div class="box">
    <h3>Keyboard Shortcuts</h3>
    <ul>
      <li>1‚Äì9: Select/toggle options</li>
      <li>Enter: Submit / Next</li>
      <li>/ : Focus search</li>
      <li>s: Settings</li>
      <li>b: Bookmark</li>
      <li>?: Keyboard help</li>
      <li>Esc: Close modals/drawers</li>
    </ul>
    <button id="closeKeys" class="btn">Close</button>
  </div>
 </div>

<!-- Toasts -->
<div class="toast-wrap" id="toasts" aria-live="polite" aria-atomic="true"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" integrity="sha512-rLAFH3b0x0Ygn+GJPD7W82dManIeZDV4SSQdlqzTeWY5Avzkdxl3pNGdisz8Iky3Uczdlz7YT1Do1B4ezwIJ1Q==" crossorigin="anonymous"></script>
<script>
(function(){
'use strict';

/* ---------- Data and State ---------- */
const STORAGE_KEY='mcq-state';
let allQuestions=[]; // full deck
let questions=[]; // current filtered deck
let current=0; // index
let score=0; // number correct
let settings={shuffleQ:true,shuffleO:true,dark:false,timeLimit:0,autoSubmit:false,tag:'',instant:false,sounds:false,anims:true,compact:false,font:'md',partial:false};
 let results=[]; // {index, selected:number[], isCorrect:boolean}
let startTime=0,elapsed=0,timerInterval=null;

/* ---------- Toasts ---------- */
function toast(msg, ms=2200){
  const wrap=document.getElementById('toasts');
  if(!wrap) return; const el=document.createElement('div');
  el.className='toast'; el.textContent=msg; wrap.appendChild(el);
  setTimeout(()=>{el.style.opacity='0';}, ms-300);
  setTimeout(()=>{if(el.parentNode) wrap.removeChild(el);}, ms);
}

/* ---------- Utility Functions ---------- */
function saveState(){
  const state={questions,allQuestions,current,score,results,settings,elapsed};
  localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
}
function loadState(){
  const data=localStorage.getItem(STORAGE_KEY);
  if(!data) return false;
  try{
    const state=JSON.parse(data);
      questions=state.questions||[];
      allQuestions=state.allQuestions||questions.slice();
      current=state.current||0;
      score=state.score||0;
      results=(state.results||[]).map(r=>({index:r.index,selected:r.selected||[],isCorrect:r.isCorrect!==undefined?r.isCorrect:r.correct||false}));
      questions.forEach(q=>{if(q.flagged===undefined) q.flagged=false;if(q.correct===undefined&&q.answer!==undefined) q.correct=q.answer;});
    settings=Object.assign(settings,state.settings||{});
      const tl=document.getElementById('timeLimit'); if(tl) tl.value=settings.timeLimit||'';
      const map={setShuffleQ:'shuffleQ',setShuffleO:'shuffleO',setInstant:'instant',setSounds:'sounds',setAnims:'anims',setCompact:'compact',setPartial:'partial'};
      Object.entries(map).forEach(([el,key])=>{const n=document.getElementById(el); if(n) n.checked=!!settings[key];});
      const sf=document.getElementById('setFont'); if(sf) sf.value=settings.font||'md';
      const sd=document.getElementById('setDark'); if(sd) sd.checked=!!settings.dark;
    if(settings.dark) document.body.classList.add('dark'); else document.body.classList.remove('dark');
    applyUiPrefs();
    elapsed=state.elapsed||0;
    startTime=Date.now()-elapsed*1000;
    if(allQuestions.length && !questions.length) questions=allQuestions.slice();
    updateTagOptions();
    document.getElementById('tagFilter').value=settings.tag||'';
    return questions.length>0;
  }catch(e){
    console.error('Failed to load state',e);
    return false;
  }
}
function resetState(){
  localStorage.removeItem(STORAGE_KEY);
  questions=[];current=0;score=0;results=[];elapsed=0;clearInterval(timerInterval);
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()* (i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}

function updateTagOptions(){
  const sel=document.getElementById('tagFilter');
  const prev=sel.value;
  const tags=new Set();
  allQuestions.forEach(q=>{(q.tags||[]).forEach(t=>tags.add(t));});
  sel.innerHTML='<option value="">All Tags</option>';
  tags.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;sel.appendChild(o);});
  if(tags.has(prev)) sel.value=prev; else sel.value='';
  sel.classList.toggle('hidden',tags.size===0);
}

function applyTagFilter(){
  const tag=document.getElementById('tagFilter').value;
  settings.tag=tag;
  questions=allQuestions.filter(q=>!tag||(q.tags||[]).includes(tag));
  if(settings.shuffleQ) shuffle(questions);
  current=0;results=[];score=0;elapsed=0;
  questions.forEach(q=>{q.answered=false;q.selected=[];q.optionsShuffled=false;});
  settings.timeLimit=parseInt(document.getElementById('timeLimit').value)||0;
  startTime=Date.now();
  startTimer();
  saveState();
  renderQuestion();
}

function editTags(){
  const q=questions[current];
  const existing=(q.tags||[]).join(', ');
  const input=prompt('Enter tags separated by commas',existing);
  if(input===null) return;
  q.tags=input.split(/[;,]/).map(s=>s.trim()).filter(Boolean);
  // update master copy
  const master=allQuestions.find(m=>m.id===q.id);
  if(master) master.tags=q.tags;
  updateTagOptions();
  renderQuestion();
  saveState();
}

  function normalizeAnswers(raw,optLen,assumeIndex=false){
    if(raw===undefined||raw===null||raw==='') return null;
    let tokens=[];
    if(Array.isArray(raw)) tokens=raw.map(String);
    else tokens=String(raw).toUpperCase().split(/[\s,;|\/]+/);
    const letters=[],numbers=[];
    tokens.forEach(t=>{
      if(!t) return;
      t=t.trim().toUpperCase();
      if(/^[A-Z]$/.test(t)) letters.push(t.charCodeAt(0)-65);
      else if(/^-?\d+$/.test(t)) numbers.push(parseInt(t,10));
    });
    let indices=[];
    if(assumeIndex){
      indices=numbers;
    }else if(numbers.length){
      const oneBased=numbers.every(n=>n>=1 && n<=optLen) && !numbers.includes(0);
      indices=numbers.map(n=>oneBased?n-1:n);
    }
    if(!assumeIndex) indices=indices.concat(letters);
    indices=indices.filter(n=>n>=0 && n<optLen);
    indices=[...new Set(indices)].sort((a,b)=>a-b);
    return indices.length?indices:null;
  }

  function normalizeCsvRow(row,idx){
    const map={};
    Object.keys(row).forEach(k=>{map[k.trim().toLowerCase()]=row[k];});
    const q=map['question'];
    if(!q) throw new Error('Missing Question');
    const options=[];
    Object.keys(map).forEach(k=>{
      const m=k.match(/^option\s+([a-z])/);
      if(m){
        const pos=m[1].toUpperCase().charCodeAt(0)-65;
        options[pos]=map[k];
      }
    });
    const opts=options.filter(o=>o!==undefined && o!=='');
    const rawAns=map['correct answer'];
    const corr=normalizeAnswers(rawAns,opts.length);
    if(!corr) throw new Error('Invalid Correct Answer');
    const tagStr=map['tags']||map['tag']||map['topic']||'';
    const tags=tagStr?tagStr.split(/[;,|]/).map(s=>s.trim()).filter(Boolean):[];
    return{ id:idx+1, question:q, options:opts, correct:corr, explanation:map['explanation']||'', rawAnswer:rawAns, tags };
  }

  function parseCsv(file){
    return new Promise((resolve,reject)=>{
      Papa.parse(file,{header:true,skipEmptyLines:true,complete:res=>{
        const qs=[];const errors=[];
        res.data.forEach((row,i)=>{
          try{qs.push(normalizeCsvRow(row,i));}
          catch(err){errors.push(`Row ${i+2}: ${err.message}`);}
        });
        if(errors.length) alert(errors.join('\n'));
        if(!qs.length) return reject(new Error('No valid rows'));
        resolve(qs);
      },error:err=>reject(err)});
    });
  }
  function parseJson(file){
    return new Promise((resolve,reject)=>{
      const reader=new FileReader();
      reader.onload=e=>{
        try{
          const data=JSON.parse(e.target.result);
          if(!Array.isArray(data)) throw new Error('JSON must be an array');
          const qs=[];const errors=[];
          data.forEach((obj,i)=>{
            try{
              if(!obj.question||!Array.isArray(obj.options)) throw new Error('Missing fields');
              const rawAns=obj.answer;
              const corr=normalizeAnswers(rawAns,obj.options.length,true);
              if(!corr) throw new Error('Invalid answer');
              const tags=Array.isArray(obj.tags)?obj.tags:(obj.tags?String(obj.tags).split(/[;,|]/).map(s=>s.trim()).filter(Boolean):[]);
              qs.push({id:obj.id||i+1,question:obj.question,options:obj.options,correct:corr,explanation:obj.explanation||'', rawAnswer:rawAns, tags});
            }catch(err){errors.push(`Item ${i+1}: ${err.message}`);}
          });
          if(errors.length) alert(errors.join('\n'));
          if(!qs.length) throw new Error('No valid questions');
          resolve(qs);
        }catch(err){reject(err);}
      };
      reader.onerror=()=>reject(reader.error);
      reader.readAsText(file);
    });
  }

  // Basic tests for normalizeAnswers
  console.assert(JSON.stringify(normalizeAnswers('B;D',4))==='[1,3]','B;D');
  console.assert(JSON.stringify(normalizeAnswers('A d',4))==='[0,3]','A d');
  console.assert(JSON.stringify(normalizeAnswers('2,4',4))==='[1,3]','2,4');
  console.assert(JSON.stringify(normalizeAnswers('0|3',4))==='[0,3]','0|3');
  console.assert(JSON.stringify(normalizeAnswers('C',4))==='[2]','C');
  console.assert(JSON.stringify(normalizeAnswers(2,4,true))==='[2]','JSON number');
  console.assert(JSON.stringify(normalizeAnswers([1,3],4,true))==='[1,3]','JSON array');

function download(text,filename){
  const blob=new Blob([text],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download=filename;a.click();
}

function formatTime(sec){
  const m=Math.floor(sec/60).toString().padStart(2,'0');
  const s=(sec%60).toString().padStart(2,'0');
  return `${m}:${s}`;
}

function startTimer(){
  clearInterval(timerInterval);
  startTime=Date.now()-elapsed*1000;
  const timerEl=document.getElementById('timer');
  const tick=()=>{
    elapsed=Math.floor((Date.now()-startTime)/1000);
    const limit=settings.timeLimit*60;
    if(limit>0){
      const remaining=limit-elapsed;
      timerEl.textContent=formatTime(Math.max(0,remaining));
      if(remaining<=0){clearInterval(timerInterval);finish();return;}
    }else{
      timerEl.textContent=formatTime(elapsed);
    }
    saveState();
  };
  tick();
  timerInterval=setInterval(tick,1000);
}

/* ---------- Rendering ---------- */
function renderQuestion(){
  if(!questions.length) return;
  const q=questions[current];
  const term=(document.getElementById('searchBox')?.value||'').trim();
  const esc=s=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  const hl=s=>term?String(s).replace(new RegExp(esc(term),'ig'),m=>`<mark>${m}</mark>`):String(s);
  document.getElementById('question').innerHTML=(current+1)+'. '+hl(q.question);
  const flag=document.getElementById('flagBtn');
  flag.textContent=q.flagged?'‚òÖ':'‚òÜ';
  flag.classList.toggle('flagged',q.flagged);
  flag.setAttribute('aria-pressed',q.flagged);
  document.getElementById('tagInfo').textContent=(q.tags&&q.tags.length)?'Tags: '+q.tags.join(', '):'';
  q.timeStart=Date.now();
  const list=document.getElementById('options');
  list.innerHTML='';
  const multi=q.correct.length>1;
  const notice=document.getElementById('multiNotice');
  if(multi){notice.textContent=`Select ALL that apply ¬∑ Choose ${q.correct.length}`;notice.classList.remove('hidden');}
  else{notice.classList.add('hidden');}
  q.shuffledOptions=q.shuffledOptions||q.options.map((o,i)=>({text:o,index:i}));
  if(settings.shuffleO && !q.optionsShuffled){shuffle(q.shuffledOptions);q.optionsShuffled=true;}
  q.shuffledOptions.forEach((o,pos)=>{
    const li=document.createElement('li');
    li.className='option';
    const input=document.createElement('input');
    input.type=multi?'checkbox':'radio';
    input.name='option';
    input.value=o.index;
    input.id='opt'+pos;
    input.checked=(q.selected||[]).includes(o.index);
    const label=document.createElement('label');
    label.setAttribute('for','opt'+pos);
    label.innerHTML=hl(o.text);
    li.appendChild(input);li.appendChild(label);
    li.setAttribute('tabindex','0');
    li.setAttribute('role',multi?'checkbox':'radio');
    li.setAttribute('aria-checked',input.checked);
    li.addEventListener('click',()=>{input.click();});
    input.addEventListener('change',()=>{
      const sel=q.selected||[];
        if(multi){
          if(input.checked){if(!sel.includes(o.index)) sel.push(o.index);} else {const p=sel.indexOf(o.index); if(p>-1) sel.splice(p,1);}
        }else{
        sel.length=0;if(input.checked) sel.push(o.index);
        document.querySelectorAll('input[name="option"]').forEach(r=>{if(r!==input) r.checked=false;});
      }
        q.selected=sel;li.setAttribute('aria-checked',input.checked);saveState();
        if((settings.autoSubmit && !multi) || settings.instant) submitAnswer();
      });
    list.appendChild(li);
  });
    list.querySelector('li')?.focus();
    document.getElementById('feedback').textContent='';
  const wrap=document.getElementById('explainWrap'); if(wrap) wrap.classList.add('hidden');
  updateProgress();
  updateScore();
  document.getElementById('submitBtn').disabled=!!q.answered;
  document.getElementById('nextBtn').classList.toggle('hidden',!q.answered);
  updateSidebar();
}
function updateProgress(){
  const pct=(current)/questions.length*100;
  document.querySelector('#progressBar div').style.width=pct+'%';
  document.getElementById('progressText').textContent=`Question ${current+1} of ${questions.length}`;
}
function updateScore(){
  score=results.filter(r=>r.isCorrect).length;
  const pct=questions.length?Math.round(score/questions.length*100):0;
  document.getElementById('score').textContent=`${score}/${questions.length} (${pct}%)`;
}

function gradeSelection(selected,correct){
  const sel=[...selected].sort((a,b)=>a-b);
  return sel.length===correct.length && sel.every((v,i)=>v===correct[i]);
}

function submitAnswer(){
  const q=questions[current];
  if(q.answered) return;
  const sel=q.selected||[];
  sel.sort((a,b)=>a-b);
  const correct=gradeSelection(sel,q.correct);
  q.answered=true;
  q.timeTaken=(q.timeTaken||0)+((Date.now()-q.timeStart)/1000);
  results[current]={index:current,selected:[...sel],isCorrect:correct};
  document.getElementById('feedback').textContent=correct?'Correct':'Incorrect';
  const options=document.querySelectorAll('#options .option');
  options.forEach(opt=>{
    const val=parseInt(opt.querySelector('input').value);
    if(q.correct.includes(val)) opt.classList.add('correct');
    if(sel.includes(val)&&!q.correct.includes(val)) opt.classList.add('incorrect');
  });
  const wrap=document.getElementById('explainWrap');
  const exp=document.getElementById('explanation');
  if(exp){exp.textContent=q.explanation||''; if(wrap) wrap.classList.remove('hidden');}
  document.getElementById('submitBtn').disabled=true;
  document.getElementById('nextBtn').classList.remove('hidden');
  updateScore();
  saveState();
}
function next(){
  if(current<questions.length-1){current++;renderQuestion();saveState();}
  else finish();
}
  function finish(){
    const correctCount=results.filter(r=>r.isCorrect).length;
    const flagged=questions.filter(q=>q.flagged).length;
    clearInterval(timerInterval);
    document.getElementById('mode').textContent='Results';
    document.getElementById('resultSummary').textContent=`Score ${correctCount} / ${questions.length} in ${formatTime(elapsed)}. Flagged ${flagged}`;
    const tbody=document.querySelector('#resultTable tbody');
    if(tbody){
      tbody.innerHTML='';
      questions.forEach((q,i)=>{
        const tr=document.createElement('tr');
        const sel=(results[i]?.selected||[]).map(n=>String.fromCharCode(65+n)).join('')||'‚Äî';
        const ans=q.correct.map(n=>String.fromCharCode(65+n)).join('');
        tr.innerHTML=`<td>${i+1}</td><td>${q.question.replace(/</g,'&lt;')}</td><td>${sel}</td><td>${ans}</td><td>${results[i]?.isCorrect?'‚úì':'‚úó'}</td>`;
        tbody.appendChild(tr);
      });
    }
    // ----- Analytics -----
    const analytics=document.getElementById('analytics');
    analytics.innerHTML='';
    const avg=questions.reduce((s,q)=>s+(q.timeTaken||0),0)/questions.length;
    const avgP=document.createElement('p');
    avgP.textContent=`Average time/question: ${avg.toFixed(1)}s`;
    analytics.appendChild(avgP);
    const tagStats={};
    questions.forEach((q,i)=>{
      const tg=(q.tags&&q.tags.length)?q.tags:['(none)'];
      tg.forEach(t=>{
        if(!tagStats[t]) tagStats[t]={total:0,correct:0};
        tagStats[t].total++;
        if(results[i]?.isCorrect) tagStats[t].correct++;
      });
    });
    if(Object.keys(tagStats).length){
      const ul=document.createElement('ul');
      ul.innerHTML='<strong>Accuracy by tag</strong>';
      Object.entries(tagStats).forEach(([tag,stat])=>{
        const li=document.createElement('li');
        li.textContent=`${tag}: ${Math.round(stat.correct/stat.total*100)}% (${stat.correct}/${stat.total})`;
        ul.appendChild(li);
      });
      analytics.appendChild(ul);
    }
    const diff=questions.map((q,i)=>({text:q.question,time:q.timeTaken||0,correct:results[i]?.isCorrect}));
    diff.sort((a,b)=>{
      if(a.correct===b.correct) return b.time-a.time;
      return a.correct?1:-1;
    });
    if(diff.length){
      const ol=document.createElement('ol');
      const title=document.createElement('strong');
      title.textContent='Hardest questions';
      analytics.appendChild(title);
      diff.slice(0,3).forEach(d=>{
        const li=document.createElement('li');
        li.textContent=`${d.text} (${d.correct?'correct':'incorrect'}, ${d.time.toFixed(1)}s)`;
        ol.appendChild(li);
      });
      analytics.appendChild(ol);
    }
    document.getElementById('resultModal').style.display='flex';
    document.querySelectorAll('#resultTable th.sortable').forEach(th=>{
      th.onclick=()=>{
        const key=th.dataset.key;const rows=[...document.querySelectorAll('#resultTable tbody tr')];
        const idx={idx:0,q:1,ok:4}[key];
        const desc=th.classList.toggle('desc');
        rows.sort((a,b)=>{
          const va=a.children[idx].textContent;const vb=b.children[idx].textContent;
          if(key==='idx'||key==='ok'){return (parseInt(va)||0)-(parseInt(vb)||0);} else {return va.localeCompare(vb);} });
        if(desc) rows.reverse();
        const tb=document.querySelector('#resultTable tbody');tb.innerHTML='';rows.forEach(r=>tb.appendChild(r));
      };
    });
    saveState();
  }
  function retryIncorrect(){
    const incorrect=questions.filter((q,i)=>!results[i]||!results[i].isCorrect);
    if(!incorrect.length){document.getElementById('resultModal').style.display='none';return;}
    document.getElementById('resultModal').style.display='none';
    startQuiz(incorrect);
  }

  function reviewFlagged(){
    const flagged=questions.filter(q=>q.flagged);
    if(!flagged.length){document.getElementById('resultModal').style.display='none';return;}
    document.getElementById('resultModal').style.display='none';
    startQuiz(flagged);
  }

/* ---------- File Handling ---------- */
async function handleFile(file){
  try{
    const ext=file.name.split('.').pop().toLowerCase();
    const qs=ext==='csv'?await parseCsv(file):await parseJson(file);
    startQuiz(qs);
  }catch(err){alert('Import error: '+err.message);}
}
function startQuiz(qs){
  allQuestions=qs.map(q=>Object.assign({flagged:false},q));
  settings.tag='';
  document.getElementById('tagFilter').value='';
  updateTagOptions();
  applyTagFilter();
  const mode=document.getElementById('mode'); if(mode) mode.textContent='Practice';
}

/* ---------- Export / Import State ---------- */
function exportResults(){
  if(!results.length) return;
  let csv='Question,YourAnswer,Correct,Explanation,Tags\n';
  questions.forEach((q,i)=>{
    const sel=(q.selected||[]).map(n=>String.fromCharCode(65+n)).join('');
    const ans=q.correct.map(n=>String.fromCharCode(65+n)).join('');
    const tags=(q.tags||[]).join('|');
    csv+=`"${q.question.replace(/"/g,'""')}",${sel},${ans},"${(q.explanation||'').replace(/"/g,'""')}","${tags}"\n`;
  });
  download(csv,'results.csv');
}
function exportState(){
  saveState();
  download(localStorage.getItem(STORAGE_KEY)||'','mcq-state.json');
}
function importStateFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{localStorage.setItem(STORAGE_KEY,e.target.result);loadState();renderQuestion();}
    catch(err){alert('Invalid state file');}
  };
  reader.readAsText(file);
}

/* ---------- Event Bindings ---------- */
document.getElementById('loadBtn').onclick=()=>document.getElementById('fileInput').click();
document.getElementById('openFileFromSettings').onclick=()=>document.getElementById('fileInput').click();
window.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT') return;
  const opts=[...document.querySelectorAll('#options input')];
  const num=parseInt(e.key,10);
  if(num>=1&&num<=opts.length){opts[num-1].click();}
  if(e.key==='Enter'){ if(!questions[current].answered) submitAnswer(); else next(); }
  if(e.key==='/'){e.preventDefault();document.getElementById('searchBox').focus();}
  if(e.key==='?'){document.getElementById('keysModal').style.display='flex';}
  if(e.key==='s'){toggleSettings();}
  if(e.key==='b'){const q=questions[current];q.flagged=!q.flagged;renderQuestion();saveState();toast(q.flagged?'Bookmarked':'Unbookmarked');}
  if(e.key==='Escape'){document.getElementById('resultModal').style.display='none';document.getElementById('keysModal').style.display='none';document.getElementById('settingsDrawer').classList.remove('open');}
});
document.getElementById('fileInput').addEventListener('change',e=>{const file=e.target.files[0];if(file)handleFile(file);});

document.getElementById('submitBtn').onclick=submitAnswer;
document.getElementById('nextBtn').onclick=next;
document.getElementById('restartBtn').onclick=()=>{if(confirm('Clear progress?')){resetState();loadSample();}};
document.getElementById('exportBtn').onclick=exportResults;
document.getElementById('darkToggle').onclick=()=>{document.body.classList.toggle('dark');settings.dark=document.body.classList.contains('dark');saveState();toast(settings.dark?'Dark mode':'Light mode');};
document.getElementById('retryBtn').onclick=retryIncorrect;
document.getElementById('flaggedBtn').onclick=reviewFlagged;
document.getElementById('closeResult').onclick=()=>document.getElementById('resultModal').style.display='none';
document.getElementById('exportStateBtn').onclick=exportState;
document.getElementById('importStateBtn').onclick=()=>document.getElementById('importState').click();
document.getElementById('importState').addEventListener('change',e=>{const f=e.target.files[0];if(f)importStateFile(f);});
document.getElementById('flagBtn').onclick=()=>{const q=questions[current];q.flagged=!q.flagged;renderQuestion();saveState();toast(q.flagged?'Bookmarked':'Unbookmarked');};
document.getElementById('noteBtn').onclick=()=>{const q=questions[current];const val=prompt('Add a short note for this question:',q.note||''); if(val===null) return; q.note=val; saveState(); updateSidebar(); toast(q.note?'Note saved':'Note cleared');};
document.getElementById('tagEditBtn').onclick=editTags;
document.getElementById('tagFilter').addEventListener('change',applyTagFilter);
const debounce=(fn,ms=250)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
document.getElementById('searchBox').addEventListener('input',debounce(()=>{renderQuestion();},200));
document.getElementById('searchBox').addEventListener('keydown',e=>{if(e.key==='Enter'){const term=e.target.value.trim().toLowerCase();if(!term)return;const i=questions.findIndex(q=>q.question.toLowerCase().includes(term));if(i>=0){current=i;renderQuestion();saveState();}else toast('No match');}});
document.getElementById('timeLimit').addEventListener('change',e=>{settings.timeLimit=parseInt(e.target.value)||0;saveState();});

function toggleSettings(){document.getElementById('settingsDrawer').classList.toggle('open');}
document.getElementById('openSettings').onclick=toggleSettings;
document.getElementById('closeSettings').onclick=toggleSettings;
document.getElementById('saveSettings').onclick=()=>{
  settings.shuffleQ=document.getElementById('setShuffleQ').checked;
  settings.shuffleO=document.getElementById('setShuffleO').checked;
  settings.instant=document.getElementById('setInstant').checked;
  settings.sounds=document.getElementById('setSounds').checked;
  settings.anims=document.getElementById('setAnims').checked;
  settings.compact=document.getElementById('setCompact').checked;
  settings.font=document.getElementById('setFont').value;
  settings.timeLimit=parseInt(document.getElementById('timeLimit').value)||0;
  settings.dark=document.getElementById('setDark').checked;
  settings.partial=document.getElementById('setPartial').checked;
  if(settings.dark) document.body.classList.add('dark'); else document.body.classList.remove('dark');
  applyUiPrefs(); saveState(); toast('Settings saved');
};
document.getElementById('closeKeys').onclick=()=>document.getElementById('keysModal').style.display='none';

function applyUiPrefs(){
  const sizes={sm:'13px',md:'16px',lg:'18px',xl:'20px'}; document.body.style.fontSize=sizes[settings.font]||'16px';
}

function updateSidebar(){
  const ul=document.getElementById('bookmarkList'); if(!ul) return; ul.innerHTML='';
  questions.forEach((q,i)=>{ if(!q.flagged) return; const li=document.createElement('li'); li.innerHTML=`<button class="btn ghost" style="width:100%;text-align:left">‚òÖ Q${i+1} ${q.note?`- ${q.note.replace(/</g,'&lt;')}`:''}</button>`; li.querySelector('button').onclick=()=>{current=i;renderQuestion();}; ul.appendChild(li);});
}

const setActive=(id)=>{document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active');};
document.getElementById('filterAll').onclick=()=>{setActive('filterAll'); questions=allQuestions.slice(); applyTagFilter(); };
document.getElementById('filterUnseen').onclick=()=>{setActive('filterUnseen'); questions=allQuestions.filter(q=>!q.answered); applyTagFilter(); };
document.getElementById('filterIncorrect').onclick=()=>{setActive('filterIncorrect'); questions=allQuestions.filter((q,i)=>results[i]&&!results[i].isCorrect); applyTagFilter(); };
document.getElementById('filterBookmarked').onclick=()=>{setActive('filterBookmarked'); questions=allQuestions.filter(q=>q.flagged); applyTagFilter(); };

/* ---------- Sample Data ---------- */
function loadSample(){
  const sampleJSON=document.getElementById('sample-json').textContent;
  const raw=JSON.parse(sampleJSON);
  const qs=raw.map((o,i)=>({
    id:o.id||i+1,
    question:o.question,
    options:o.options,
    correct:normalizeAnswers(o.answer,o.options.length,true),
    explanation:o.explanation||'',
    rawAnswer:o.answer,
    tags:o.tags||[]
  }));
  startQuiz(qs);
}

/* ---------- Init ---------- */
// Theme default from prefers-color-scheme on first load
if(!localStorage.getItem(STORAGE_KEY)){
  try{ if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){ document.body.classList.add('dark'); settings.dark=true; } }catch{}
}
if(!loadState()){
  // if no previous state, load sample csv
  loadSample();
}else{
  renderQuestion();
  if(results.length<questions.length) startTimer(); else document.getElementById('timer').textContent=formatTime(elapsed);
}
// prepare downloadable sample CSV
const sampleCsv=document.getElementById('sample-csv').textContent;
const link=document.getElementById('sampleCsvLink');
link.href=URL.createObjectURL(new Blob([sampleCsv],{type:'text/csv'}));
link.textContent='Download sample CSV';
link.classList.remove('hidden');

// Sync settings controls with current settings on first render
const mapInit=[['setShuffleQ','shuffleQ'],['setShuffleO','shuffleO'],['setInstant','instant'],['setSounds','sounds'],['setAnims','anims'],['setCompact','compact'],['setPartial','partial']];
mapInit.forEach(([id,key])=>{const el=document.getElementById(id); if(el) el.checked=!!settings[key];});
const sf=document.getElementById('setFont'); if(sf) sf.value=settings.font||'md';
const sd=document.getElementById('setDark'); if(sd) sd.checked=!!settings.dark;
applyUiPrefs();

})();
</script>

<script id="sample-json" type="application/json">[
  {
    "question":"What is the capital of France?",
    "options":["Paris","London","Berlin","Madrid"],
    "answer":0,
    "explanation":"Paris is the capital of France.",
    "tags":["geography"]
  },
  {
    "question":"Which planet is known as the Red Planet?",
    "options":["Earth","Venus","Mars","Jupiter"],
    "answer":2,
    "explanation":"The iron oxide on Mars gives it a reddish appearance.",
    "tags":["space"]
  },
  {
    "question":"Which of the following are prime numbers?",
    "options":["2","3","4","5"],
    "answer":[0,1,3],
    "explanation":"2, 3 and 5 are prime numbers.",
    "tags":["math"]
  }
]</script>
</script>

<script id="sample-csv" type="text/plain">Question,Option A,Option B,Option C,Option D,Correct Answer,Explanation,Tags
What is the capital of France?,Paris,London,Berlin,Madrid,A,Paris is the capital of France.,geography
Which planet is known as the Red Planet?,Earth,Venus,Mars,Jupiter,C,The iron oxide on Mars gives it a reddish appearance.,space
Which of the following are prime numbers?,2,3,4,5,A;B;D,2, 3 and 5 are prime numbers.,math
</script>

</body>
</html>
