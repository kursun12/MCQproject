<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SC-200 Practice</title>
<style>
  /* Basic layout */
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f7f7f7;color:#222;display:flex;flex-direction:column;min-height:100vh;}
  header{background:#004578;color:#fff;padding:.5rem;display:flex;flex-wrap:wrap;align-items:center;gap:.5rem;}
  header h1{font-size:1.2rem;margin-right:auto;}
  header button,header select,header input{font-size:.9rem;padding:.3rem .5rem;}
  #progress{flex:1;margin-left:.5rem;height:8px;background:#ccc;border-radius:4px;overflow:hidden;}
  #progress div{height:100%;width:0;background:#0078d4;}
  #timer,#score{margin-left:.5rem;}
  main{flex:1;padding:1rem;display:flex;flex-direction:column;}
  .question{font-size:1.1rem;margin-bottom:1rem;}
  .options{display:flex;flex-direction:column;gap:.5rem;}
  .option{padding:.6rem;border:1px solid #999;border-radius:6px;background:#fff;cursor:pointer;text-align:left;}
  .option[aria-checked="true"],.option:focus{outline:2px solid #0078d4;}
  .option.correct{border-color:#0a0;background:#e6ffe6;}
  .option.incorrect{border-color:#c00;background:#ffe6e6;}
  .hidden{display:none;}
  #explanation{margin-top:1rem;border-top:1px solid #ddd;padding-top:.5rem;}
  footer{padding:.5rem;background:#eee;display:flex;align-items:center;gap:1rem;}
  footer button{padding:.4rem .8rem;}
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);}
  .modal .box{background:#fff;color:#222;padding:1rem;border-radius:8px;max-width:90%;max-height:90%;overflow:auto;}
  table{border-collapse:collapse;width:100%;}
  th,td{border:1px solid #ccc;padding:.3rem;text-align:left;}
  @media(max-width:600px){header{flex-direction:column;align-items:flex-start;}#progress{width:100%;margin:0.5rem 0;}}
  @media print{header,footer,.modal{display:none;}body{background:#fff;color:#000;}}
</style>
</head>
<body>
<header>
  <h1>SC-200 Practice</h1>
  <input type="file" id="fileInput" accept=".csv" class="hidden" />
  <button id="importBtn">Import CSV</button>
  <select id="modeSelect">
    <option value="study">Study</option>
    <option value="test">Test</option>
    <option value="cram">Cram</option>
  </select>
  <label>Shuffle Qs<input type="checkbox" id="shuffleQuestions"/></label>
  <label>Shuffle Opts<input type="checkbox" id="shuffleOptions"/></label>
  <label>Range <input type="number" id="rangeStart" min="1" style="width:4rem;">-<input type="number" id="rangeEnd" min="1" style="width:4rem;"></label>
  <input type="text" id="keyword" placeholder="keyword"/>
  <label><input type="checkbox" id="onlyUnanswered">Unanswered</label>
  <label><input type="checkbox" id="onlyIncorrect">Incorrect</label>
  <div id="timer">00:00</div>
  <div id="score"></div>
  <div id="progress"><div></div></div>
</header>
<main aria-live="polite">
  <div id="quiz"></div>
</main>
<footer>
  <button id="prevBtn">Previous</button>
  <button id="nextBtn">Next</button>
  <button id="bookmarkBtn">Bookmark</button>
  <button id="resetSessionBtn">Reset session</button>
  <button id="resetAllBtn">Reset all</button>
  <button id="exportBtn">Export results CSV</button>
</footer>

<!-- Import summary modal -->
<div class="modal" id="importModal" role="dialog" aria-modal="true">
  <div class="box">
    <h2>Import Summary</h2>
    <div id="importSummary"></div>
    <h3>Preview</h3>
    <table id="previewTable"></table>
    <h3>Skipped Rows</h3>
    <div id="skippedList"></div>
    <button id="useDataBtn">Use Questions</button>
    <button class="close">Close</button>
  </div>
</div>

<!-- Results modal -->
<div class="modal" id="resultsModal" role="dialog" aria-modal="true">
  <div class="box">
    <h2>Results</h2>
    <div id="resultSummary"></div>
    <div id="breakdown"></div>
    <button id="restartBtn">Restart quiz</button>
    <button id="reviewIncorrectBtn">Review incorrect</button>
    <button class="close">Close</button>
  </div>
</div>

<!-- Review modal -->
<div class="modal" id="reviewModal" role="dialog" aria-modal="true">
  <div class="box">
    <h2>Review</h2>
    <div id="reviewContainer"></div>
    <button class="close">Close</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" integrity="sha512-rLAFH3b0x0Ygn+GJPD7W82dManIeZDV4SSQdlqzTeWY5Avzkdxl3pNGdisz8Iky3Uczdlz7YT1Do1B4ezwIJ1Q==" crossorigin="anonymous"></script>
<script>
(function(){
  const deckKey='mcqDeck';
  let allQuestions=[]; // full dataset with state
  let quizQuestions=[]; // current filtered set
  let index=0; // current question index
  let mode='study';
  let timer=null,startTime=0;
  let results=[]; // for export

  const quizEl=document.getElementById('quiz');
  const progressBar=document.querySelector('#progress div');
  const timerEl=document.getElementById('timer');
  const scoreEl=document.getElementById('score');

  /* Utility */
  function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()* (i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}

  function parseCsv(file){
    return new Promise((resolve,reject)=>{
      Papa.parse(file,{header:true,skipEmptyLines:true,complete:res=>resolve(res),error:err=>reject(err)});
    });
  }

  function validateRows(res){
    const required=['QuestionNumber','Question','Option A','Option B','Option C','Option D','Shown Answer','Correct Answer','Explanation'];
    if(JSON.stringify(res.meta.fields)!==JSON.stringify(required)){
      throw new Error('CSV columns mismatch. Expect header: '+required.join(', '));
    }
    const seen=new Set();
    const valid=[],skipped=[];
    res.data.forEach((row,i)=>{
      const num=row['QuestionNumber'];
      if(seen.has(num)){skipped.push({row:i+2,reason:'Duplicate QuestionNumber'});return;}
      seen.add(num);
      const opts=['Option A','Option B','Option C','Option D'].map(k=>row[k]);
      const filled=opts.filter(o=>o!==undefined && o!==null && o!=='' );
      if(filled.length<2){skipped.push({row:i+2,reason:'<2 options'});return;}
      const correct=(row['Correct Answer']||'').trim().toUpperCase();
      const letters=['A','B','C','D'];
      const correctIdx=letters.indexOf(correct);
      if(correctIdx===-1||!opts[correctIdx]){skipped.push({row:i+2,reason:'Invalid Correct Answer'});return;}
      valid.push(normalizeQuestion(row,opts,correctIdx));
    });
    return {valid,skipped};
  }

  function normalizeQuestion(row,opts,correctIdx){
    return {
      num:row['QuestionNumber'],
      text:row['Question'],
      options:opts.map((t,i)=>({text:t,letter:['A','B','C','D'][i]})),
      correctIndex:correctIdx,
      explanation:row['Explanation']||'',
      shownAnswer:row['Shown Answer']||'',
      chosen:null,
      bookmarked:false
    };
  }

  function saveState(){localStorage.setItem(deckKey,JSON.stringify(allQuestions));}
  function loadState(){const d=localStorage.getItem(deckKey);if(d){allQuestions=JSON.parse(d);} }
  function resetSession(){allQuestions.forEach(q=>{q.chosen=null;q.bookmarked=false;});saveState();}
  function resetAll(){localStorage.clear();location.reload();}

  function applyFilters(){
    let qs=[...allQuestions];
    const start=parseInt(document.getElementById('rangeStart').value)||-Infinity;
    const end=parseInt(document.getElementById('rangeEnd').value)||Infinity;
    qs=qs.filter(q=>q.num>=start && q.num<=end);
    const kw=document.getElementById('keyword').value.toLowerCase();
    if(kw) qs=qs.filter(q=>q.text.toLowerCase().includes(kw)||q.explanation.toLowerCase().includes(kw));
    if(document.getElementById('onlyUnanswered').checked) qs=qs.filter(q=>q.chosen==null);
    if(document.getElementById('onlyIncorrect').checked) qs=qs.filter(q=>q.chosen!=null && q.chosen!==q.correctIndex);
    if(document.getElementById('shuffleQuestions').checked) shuffle(qs);
    return qs;
  }

  function shuffleOptions(q){
    const arr=q.options;
    const correctText=arr[q.correctIndex].text;
    shuffle(arr);
    q.correctIndex=arr.findIndex(o=>o.text===correctText);
  }

  function startQuiz(m){
    mode=m;results=[];index=0;quizQuestions=applyFilters().map(q=>({...q}));
    if(document.getElementById('shuffleOptions').checked) quizQuestions.forEach(shuffleOptions);
    startTime=Date.now();timerEl.textContent='00:00';clearInterval(timer);timer=setInterval(()=>{const s=Math.floor((Date.now()-startTime)/1000);timerEl.textContent=('0'+Math.floor(s/60)).slice(-2)+':'+('0'+s%60).slice(-2);},1000);
    renderQuestion();updateScore();
  }

  function renderQuestion(){
    if(index>=quizQuestions.length){finishQuiz();return;}
    const q=quizQuestions[index];
    let html='<div class="question">'+q.text+'</div>';
    if(mode==='cram' && !q.showing){html+='<button id="revealBtn">Reveal options</button>';quizEl.innerHTML=html;document.getElementById('revealBtn').onclick=()=>{q.showing=true;renderQuestion();};return;}
    html+='<div id="options" role="radiogroup" class="options">';
    q.options.forEach((o,i)=>{html+='<button class="option" role="radio" data-index="'+i+'" aria-checked="false">'+String.fromCharCode(65+i)+'. '+o.text+'</button>';});
    html+='</div><div id="feedback" aria-live="polite"></div>';
    html+='<details id="explanation" class="hidden"><summary>Explanation</summary>'+q.explanation+'</details>';
    quizEl.innerHTML=html;
    Array.from(document.querySelectorAll('.option')).forEach(btn=>btn.addEventListener('click',()=>selectOption(btn)));
    document.addEventListener('keydown',keyHandler);
    updateProgress();
  }

  let selected=-1;
  function selectOption(btn){
    document.querySelectorAll('.option').forEach(b=>{b.setAttribute('aria-checked','false');b.classList.remove('selected');});
    btn.setAttribute('aria-checked','true');btn.classList.add('selected');selected=parseInt(btn.dataset.index);
  }

  function keyHandler(e){
    const opts=document.querySelectorAll('.option');
    if(['ArrowDown','ArrowRight'].includes(e.key)){if(selected<opts.length-1){selectOption(opts[selected+1]||opts[0]);}}
    if(['ArrowUp','ArrowLeft'].includes(e.key)){if(selected>0){selectOption(opts[selected-1]||opts[opts.length-1]);}}
    const num=parseInt(e.key)-1;if(num>=0 && num<opts.length){selectOption(opts[num]);}
    if(e.key==='Enter'){submitAnswer();}
  }

  function submitAnswer(){
    const q=quizQuestions[index];
    if(selected<0) return;
    q.chosen=selected;
    const correct=selected===q.correctIndex;
    allQuestions.find(x=>x.num===q.num).chosen=selected;
    saveState();
    results.push({QuestionNumber:q.num,ChosenAnswer:String.fromCharCode(65+selected),CorrectAnswer:String.fromCharCode(65+q.correctIndex),IsCorrect:correct,Mode:mode,Timestamp:new Date().toISOString()});
    if(mode==='study'||mode==='cram'){
      const opts=document.querySelectorAll('.option');
      opts[q.correctIndex].classList.add('correct');
      if(!correct) opts[selected].classList.add('incorrect');
      document.getElementById('feedback').textContent=correct?'Correct':'Incorrect';
      document.getElementById('explanation').classList.remove('hidden');
    }
    updateScore();
    document.removeEventListener('keydown',keyHandler);
  }

  function next(){selected=-1;index++;renderQuestion();}
  function prev(){if(index>0){index--;selected=-1;renderQuestion();}}

  function updateProgress(){progressBar.style.width=((index)/quizQuestions.length*100)+'%';document.querySelector('header').setAttribute('aria-label','Question '+(index+1)+' of '+quizQuestions.length);}
  function updateScore(){if(mode==='study'||mode==='cram'){const ans=results.filter(r=>r.IsCorrect).length;scoreEl.textContent=ans+'/'+quizQuestions.length;}};

  function finishQuiz(){clearInterval(timer);progressBar.style.width='100%';let correct=results.filter(r=>r.IsCorrect).length;const total=quizQuestions.length;const time=timerEl.textContent;document.getElementById('resultSummary').innerHTML=`Score ${correct}/${total} in ${time}`;const breakdown={A:0,B:0,C:0,D:0};results.forEach(r=>{breakdown[r.ChosenAnswer]++});let bd='';for(const k in breakdown){bd+=k+': '+breakdown[k]+'<br>';};document.getElementById('breakdown').innerHTML=bd;document.getElementById('resultsModal').style.display='flex';}

  function exportResultsCsv(){if(results.length===0)return;let csv='QuestionNumber,ChosenAnswer,CorrectAnswer,IsCorrect,Mode,Timestamp\n';results.forEach(r=>{csv+=`${r.QuestionNumber},${r.ChosenAnswer},${r.CorrectAnswer},${r.IsCorrect},${r.Mode},${r.Timestamp}\n`;});const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='results.csv';a.click();}

  function renderReview(filter){const qs=allQuestions.filter(q=>filter==='incorrect'?q.chosen!==null&&q.chosen!==q.correctIndex:q.bookmarked);let html='';qs.forEach(q=>{html+=`<div><strong>${q.num}. ${q.text}</strong><br>`;q.options.forEach((o,i)=>{const cls=i===q.correctIndex?'correct':(i===q.chosen?'incorrect':'');html+=`<div class="option ${cls}">${String.fromCharCode(65+i)}. ${o.text}</div>`;});html+=`<div>${q.explanation}</div><hr></div>`;});document.getElementById('reviewContainer').innerHTML=html||'None';document.getElementById('reviewModal').style.display='flex';}

  /* Event bindings */
  document.getElementById('importBtn').onclick=()=>document.getElementById('fileInput').click();
  document.getElementById('fileInput').addEventListener('change',async e=>{const file=e.target.files[0];if(!file)return;try{const res=await parseCsv(file);const {valid,skipped}=validateRows(res);showImportSummary(valid,skipped);}catch(err){alert(err.message);}});

  function showImportSummary(valid,skipped){document.getElementById('previewTable').innerHTML='';valid.slice(0,3).forEach(q=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${q.num}</td><td>${q.text}</td>`;document.getElementById('previewTable').appendChild(tr);});document.getElementById('importSummary').textContent=`Imported ${valid.length} questions. Skipped ${skipped.length}.`;document.getElementById('skippedList').innerHTML=skipped.map(s=>`Row ${s.row}: ${s.reason}`).join('<br>');document.getElementById('importModal').style.display='flex';document.getElementById('useDataBtn').onclick=()=>{allQuestions=valid;saveState();document.getElementById('importModal').style.display='none';};}

  document.querySelectorAll('.modal .close').forEach(btn=>btn.onclick=e=>e.target.closest('.modal').style.display='none');

  document.getElementById('modeSelect').addEventListener('change',e=>startQuiz(e.target.value));
  document.getElementById('nextBtn').onclick=()=>{if(selected===-1)submitAnswer();next();};
  document.getElementById('prevBtn').onclick=prev;
  document.getElementById('bookmarkBtn').onclick=()=>{const q=quizQuestions[index];q.bookmarked=!q.bookmarked;allQuestions.find(x=>x.num===q.num).bookmarked=q.bookmarked;saveState();};
  document.getElementById('resetSessionBtn').onclick=()=>{if(confirm('Clear progress?')){resetSession();}};
  document.getElementById('resetAllBtn').onclick=()=>{if(confirm('Clear all data?'))resetAll();};
  document.getElementById('exportBtn').onclick=exportResultsCsv;
  document.getElementById('restartBtn').onclick=()=>{document.getElementById('resultsModal').style.display='none';startQuiz(mode);};
  document.getElementById('reviewIncorrectBtn').onclick=()=>{document.getElementById('resultsModal').style.display='none';renderReview('incorrect');};

  document.getElementById('reviewModal').querySelector('.close').onclick=()=>document.getElementById('reviewModal').style.display='none';

  loadState();if(allQuestions.length)startQuiz('study');

  /* Acceptance tests (manual):
    1. Import provided sample CSV. Expect preview first 3 questions and summary.
    2. Toggle shuffle options and ensure correct answers remain valid.
    3. Answer 5 questions in Test mode; finish and see results with explanations.
    4. Filter by keyword 'Key Vault' to show only matching questions.
    5. Bookmark two questions and open Review (bookmarked) via renderReview('bookmarked').
    6. Export results CSV and check headers/rows.
  */
})();
</script>
</body>
</html>
