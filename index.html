<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MCQ Practice</title>
<!--
README
------
This is a client-side Multiple Choice Question (MCQ) practice tool.

Loading Questions
- Click "Load Questions" and choose a CSV or JSON file.
  - CSV format columns can appear in any order: Question, Option A..Z, Correct Answer, Explanation.
    - Correct Answer may be letters or numbers separated by comma, semicolon, pipe, slash or whitespace ("B;D", "2 4").
  - JSON format: array of objects with keys {id?, question, options, answer, explanation}.
    - answer can be a number or an array of indices (0-based or 1-based).
- A small demo dataset is included (see bottom of file) and is loaded automatically if no file is provided.

Multi-Answer Detection
  - Answers are normalized to sorted arrays of 0-based option indices.
  - If an answer array contains more than one index, the question is treated as multi-select and rendered with checkboxes and a "Select all that apply" notice.
  - Single-answer questions use radio buttons.

Session Persistence
- Progress, selected answers, and settings are stored in localStorage under the key "mcq-state".
- On page load the app attempts to resume the previous session.
- Use the "Reset" button to clear stored data.

Exporting Results/State
- After finishing the quiz you can export the results as CSV.
- The full application state (questions, answers, settings) can be exported and later imported to resume on another machine.

Timer & Utilities
- Optional overall timer: set a limit (minutes) before starting; progress auto-stops at time limit.
- Bookmark questions with the ‚òÜ button and review them later.
- Use the search box to jump to a question containing specific text.
- Questions may include optional tags. Use the tag dropdown to filter the deck or the üè∑Ô∏è button to add your own tags.
- End screen shows basic analytics: average time per question, accuracy by tag and hardest questions.
-->
<style>
:root{
  --bg:#ffffff;
  --fg:#222222;
  --accent:#1976d2;
  --correct:#188038;
  --incorrect:#c62828;
}
body.dark{
  --bg:#1e1e1e;
  --fg:#dddddd;
  --accent:#90caf9;
  --correct:#00e676;
  --incorrect:#ef5350;
}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  display:flex;
  flex-direction:column;
  min-height:100vh;
}
header{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:.5rem;
  padding:.5rem 1rem;
  background:var(--accent);
  color:#fff;
}
header h1{font-size:1.2rem;margin-right:auto;}
header button,header label,header select{font-size:.9rem;}
#tagFilter{max-width:10rem;}
#progressBar{flex:1;height:8px;background:#ccc;border-radius:4px;overflow:hidden;}
#progressBar div{height:100%;width:0;background:#fff;}
main{flex:1;padding:1rem;display:flex;flex-direction:column;}
.question{font-size:1.1rem;margin-bottom:1rem;}
.hidden{display:none;}
#multiNotice{margin:.5rem 0;font-weight:bold;color:var(--accent);}
.options{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:.5rem;}
.option{padding:.6rem;border:1px solid #999;border-radius:6px;cursor:pointer;background:var(--bg);color:var(--fg);}
.option input{margin-right:.5rem;}
.option.correct{border-color:var(--correct);background:#e6ffe6;}
.option.incorrect{border-color:var(--incorrect);background:#ffe6e6;}
#resultList{margin-top:1rem;}
#resultList li.correct{color:var(--correct);}
#resultList li.incorrect{color:var(--incorrect);}
footer{padding:.5rem;background:#eee;display:flex;align-items:center;gap:1rem;}
footer button{padding:.4rem .8rem;}
#timer{font-weight:bold;margin:0 .5rem;}
#flagBtn{background:var(--bg);color:var(--fg);border:1px solid #999;border-radius:4px;cursor:pointer;}
#flagBtn.flagged{color:var(--accent);}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);}
.modal .box{background:var(--bg);color:var(--fg);padding:1rem;border-radius:8px;max-width:90%;max-height:90%;overflow:auto;}
@media(max-width:600px){header{flex-direction:column;align-items:flex-start;}#progressBar{width:100%;order:99;}}
</style>
</head>
<body>
<header>
  <h1>MCQ Practice</h1>
  <input type="file" id="fileInput" accept=".csv,.json" class="hidden" />
  <button id="loadBtn">Load Questions</button>
  <label>Shuffle Qs <input type="checkbox" id="shuffleQ" checked /></label>
  <label>Shuffle Opts <input type="checkbox" id="shuffleO" checked /></label>
  <label>Auto Submit <input type="checkbox" id="autoSubmit" /></label>
  <label>Time (min) <input type="number" id="timeLimit" min="0" style="width:4rem" /></label>
  <div id="timer">00:00</div>
  <input type="search" id="searchBox" placeholder="Search..." />
  <select id="tagFilter" class="hidden" title="Filter by tag"><option value="">All Tags</option></select>
  <button id="darkToggle" aria-label="Toggle dark mode">Dark</button>
  <div id="progressText"></div>
  <div id="progressBar"><div></div></div>
  <div id="score"></div>
  <a id="sampleCsvLink" download="sample.csv" class="hidden"></a>
</header>
<main aria-live="polite">
  <div id="quiz">
    <div id="questionRow" style="display:flex;align-items:center;gap:.5rem;">
      <div id="question" class="question" style="flex:1"></div>
      <button id="tagEditBtn" title="Edit tags">üè∑Ô∏è</button>
      <button id="flagBtn" title="Bookmark question">‚òÜ</button>
    </div>
    <div id="multiNotice" class="hidden"></div>
    <div id="tagInfo" style="font-size:.9rem;color:var(--accent);"></div>
    <ul id="options" class="options"></ul>
    <div id="feedback"></div>
    <div id="explanation" class="hidden"></div>
  </div>
</main>
<footer>
  <button id="submitBtn">Submit</button>
  <button id="nextBtn" class="hidden">Next</button>
  <button id="restartBtn">Restart</button>
  <button id="exportBtn">Export CSV</button>
  <button id="exportStateBtn">Export State</button>
  <input type="file" id="importState" class="hidden" />
  <button id="importStateBtn">Import State</button>
</footer>

<div id="resultModal" class="modal" role="dialog" aria-modal="true">
  <div class="box">
    <h2>Results</h2>
    <div id="resultSummary"></div>
    <div id="analytics"></div>
    <ol id="resultList"></ol>
    <button id="retryBtn">Retry Incorrect</button>
    <button id="flaggedBtn">Review Flagged</button>
    <button id="closeResult">Close</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" integrity="sha512-rLAFH3b0x0Ygn+GJPD7W82dManIeZDV4SSQdlqzTeWY5Avzkdxl3pNGdisz8Iky3Uczdlz7YT1Do1B4ezwIJ1Q==" crossorigin="anonymous"></script>
<script>
(function(){
'use strict';

/* ---------- Data and State ---------- */
const STORAGE_KEY='mcq-state';
let allQuestions=[]; // full deck
let questions=[]; // current filtered deck
let current=0; // index
let score=0; // number correct
let settings={shuffleQ:true,shuffleO:true,dark:false,timeLimit:0,autoSubmit:false,tag:''};
 let results=[]; // {index, selected:number[], isCorrect:boolean}
let startTime=0,elapsed=0,timerInterval=null;

/* ---------- Utility Functions ---------- */
function saveState(){
  const state={questions,allQuestions,current,score,results,settings,elapsed};
  localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
}
function loadState(){
  const data=localStorage.getItem(STORAGE_KEY);
  if(!data) return false;
  try{
    const state=JSON.parse(data);
      questions=state.questions||[];
      allQuestions=state.allQuestions||questions.slice();
      current=state.current||0;
      score=state.score||0;
      results=(state.results||[]).map(r=>({index:r.index,selected:r.selected||[],isCorrect:r.isCorrect!==undefined?r.isCorrect:r.correct||false}));
      questions.forEach(q=>{if(q.flagged===undefined) q.flagged=false;if(q.correct===undefined&&q.answer!==undefined) q.correct=q.answer;});
    settings=Object.assign(settings,state.settings||{});
      document.getElementById('shuffleQ').checked=settings.shuffleQ;
      document.getElementById('shuffleO').checked=settings.shuffleO;
      document.getElementById('autoSubmit').checked=settings.autoSubmit;
      document.getElementById('timeLimit').value=settings.timeLimit||'';
    if(settings.dark) document.body.classList.add('dark');
    elapsed=state.elapsed||0;
    startTime=Date.now()-elapsed*1000;
    if(allQuestions.length && !questions.length) questions=allQuestions.slice();
    updateTagOptions();
    document.getElementById('tagFilter').value=settings.tag||'';
    return questions.length>0;
  }catch(e){
    console.error('Failed to load state',e);
    return false;
  }
}
function resetState(){
  localStorage.removeItem(STORAGE_KEY);
  questions=[];current=0;score=0;results=[];elapsed=0;clearInterval(timerInterval);
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()* (i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}

function updateTagOptions(){
  const sel=document.getElementById('tagFilter');
  const prev=sel.value;
  const tags=new Set();
  allQuestions.forEach(q=>{(q.tags||[]).forEach(t=>tags.add(t));});
  sel.innerHTML='<option value="">All Tags</option>';
  tags.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;sel.appendChild(o);});
  if(tags.has(prev)) sel.value=prev; else sel.value='';
  sel.classList.toggle('hidden',tags.size===0);
}

function applyTagFilter(){
  const tag=document.getElementById('tagFilter').value;
  settings.tag=tag;
  questions=allQuestions.filter(q=>!tag||(q.tags||[]).includes(tag));
  if(document.getElementById('shuffleQ').checked) shuffle(questions);
  current=0;results=[];score=0;elapsed=0;
  questions.forEach(q=>{q.answered=false;q.selected=[];q.optionsShuffled=false;});
  settings.shuffleQ=document.getElementById('shuffleQ').checked;
  settings.shuffleO=document.getElementById('shuffleO').checked;
  settings.autoSubmit=document.getElementById('autoSubmit').checked;
  settings.timeLimit=parseInt(document.getElementById('timeLimit').value)||0;
  startTime=Date.now();
  startTimer();
  saveState();
  render();
}

function editTags(){
  const q=questions[current];
  const existing=(q.tags||[]).join(', ');
  const input=prompt('Enter tags separated by commas',existing);
  if(input===null) return;
  q.tags=input.split(/[;,]/).map(s=>s.trim()).filter(Boolean);
  // update master copy
  const master=allQuestions.find(m=>m.id===q.id);
  if(master) master.tags=q.tags;
  updateTagOptions();
  render();
  saveState();
}

  function normalizeAnswers(raw,optLen,assumeIndex=false){
    if(raw===undefined||raw===null||raw==='') return null;
    let tokens=[];
    if(Array.isArray(raw)) tokens=raw.map(String);
    else tokens=String(raw).toUpperCase().split(/[\s,;|\/]+/);
    const letters=[],numbers=[];
    tokens.forEach(t=>{
      if(!t) return;
      t=t.trim().toUpperCase();
      if(/^[A-Z]$/.test(t)) letters.push(t.charCodeAt(0)-65);
      else if(/^-?\d+$/.test(t)) numbers.push(parseInt(t,10));
    });
    let indices=[];
    if(assumeIndex){
      indices=numbers;
    }else if(numbers.length){
      const oneBased=numbers.every(n=>n>=1 && n<=optLen) && !numbers.includes(0);
      indices=numbers.map(n=>oneBased?n-1:n);
    }
    indices=indices.concat(letters);
    indices=indices.filter(n=>n>=0 && n<optLen);
    indices=[...new Set(indices)].sort((a,b)=>a-b);
    return indices.length?indices:null;
  }

  function normalizeCSVRow(row,idx){
    const map={};
    Object.keys(row).forEach(k=>{map[k.trim().toLowerCase()]=row[k];});
    const q=map['question'];
    if(!q) throw new Error('Missing Question');
    const options=[];
    Object.keys(map).forEach(k=>{
      const m=k.match(/^option\s+([a-z])/);
      if(m){
        const pos=m[1].toUpperCase().charCodeAt(0)-65;
        options[pos]=map[k];
      }
    });
    const opts=options.filter(o=>o!==undefined && o!=='');
    const rawAns=map['correct answer'];
    const corr=normalizeAnswers(rawAns,opts.length);
    if(!corr) throw new Error('Invalid Correct Answer');
    const tagStr=map['tags']||map['tag']||map['topic']||'';
    const tags=tagStr?tagStr.split(/[;,|]/).map(s=>s.trim()).filter(Boolean):[];
    return{ id:idx+1, question:q, options:opts, correct:corr, explanation:map['explanation']||'', rawAnswer:rawAns, tags };
  }

  function parseCSV(file){
    return new Promise((resolve,reject)=>{
      Papa.parse(file,{header:true,skipEmptyLines:true,complete:res=>{
        const qs=[];const errors=[];
        res.data.forEach((row,i)=>{
          try{qs.push(normalizeCSVRow(row,i));}
          catch(err){errors.push(`Row ${i+2}: ${err.message}`);}
        });
        if(errors.length) alert(errors.join('\n'));
        if(!qs.length) return reject(new Error('No valid rows'));
        resolve(qs);
      },error:err=>reject(err)});
    });
  }
  function parseJSON(file){
    return new Promise((resolve,reject)=>{
      const reader=new FileReader();
      reader.onload=e=>{
        try{
          const data=JSON.parse(e.target.result);
          if(!Array.isArray(data)) throw new Error('JSON must be an array');
          const qs=[];const errors=[];
          data.forEach((obj,i)=>{
            try{
              if(!obj.question||!Array.isArray(obj.options)) throw new Error('Missing fields');
              const rawAns=obj.answer;
              const corr=normalizeAnswers(rawAns,obj.options.length,true);
              if(!corr) throw new Error('Invalid answer');
              const tags=Array.isArray(obj.tags)?obj.tags:(obj.tags?String(obj.tags).split(/[;,|]/).map(s=>s.trim()).filter(Boolean):[]);
              qs.push({id:obj.id||i+1,question:obj.question,options:obj.options,correct:corr,explanation:obj.explanation||'', rawAnswer:rawAns, tags});
            }catch(err){errors.push(`Item ${i+1}: ${err.message}`);}
          });
          if(errors.length) alert(errors.join('\n'));
          if(!qs.length) throw new Error('No valid questions');
          resolve(qs);
        }catch(err){reject(err);}
      };
      reader.onerror=()=>reject(reader.error);
      reader.readAsText(file);
    });
  }

  // Basic tests for normalizeAnswers
  console.assert(JSON.stringify(normalizeAnswers('B;D',4))==='[1,3]','B;D');
  console.assert(JSON.stringify(normalizeAnswers('A d',4))==='[0,3]','A d');
  console.assert(JSON.stringify(normalizeAnswers('2,4',4))==='[1,3]','2,4');
  console.assert(JSON.stringify(normalizeAnswers('0|3',4))==='[0,3]','0|3');
  console.assert(JSON.stringify(normalizeAnswers('C',4))==='[2]','C');
  console.assert(JSON.stringify(normalizeAnswers(2,4,true))==='[2]','JSON number');
  console.assert(JSON.stringify(normalizeAnswers([1,3],4,true))==='[1,3]','JSON array');

function download(text,filename){
  const blob=new Blob([text],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download=filename;a.click();
}

function formatTime(sec){
  const m=Math.floor(sec/60).toString().padStart(2,'0');
  const s=(sec%60).toString().padStart(2,'0');
  return `${m}:${s}`;
}

function startTimer(){
  clearInterval(timerInterval);
  startTime=Date.now()-elapsed*1000;
  const timerEl=document.getElementById('timer');
  const tick=()=>{
    elapsed=Math.floor((Date.now()-startTime)/1000);
    const limit=settings.timeLimit*60;
    if(limit>0){
      const remaining=limit-elapsed;
      timerEl.textContent=formatTime(Math.max(0,remaining));
      if(remaining<=0){clearInterval(timerInterval);finish();return;}
    }else{
      timerEl.textContent=formatTime(elapsed);
    }
    saveState();
  };
  tick();
  timerInterval=setInterval(tick,1000);
}

/* ---------- Rendering ---------- */
function render(){
  if(!questions.length) return;
  const q=questions[current];
  document.getElementById('question').innerHTML=(current+1)+'. '+q.question;
  const flag=document.getElementById('flagBtn');
  flag.textContent=q.flagged?'‚òÖ':'‚òÜ';
  flag.classList.toggle('flagged',q.flagged);
  flag.setAttribute('aria-pressed',q.flagged);
  document.getElementById('tagInfo').textContent=(q.tags&&q.tags.length)?'Tags: '+q.tags.join(', '):'';
  q.timeStart=Date.now();
  const list=document.getElementById('options');
  list.innerHTML='';
  const multi=q.correct.length>1;
  const notice=document.getElementById('multiNotice');
  if(multi){notice.textContent=`Select all that apply (Choose ${q.correct.length})`;notice.classList.remove('hidden');}
  else{notice.classList.add('hidden');}
  q.shuffledOptions=q.shuffledOptions||q.options.map((o,i)=>({text:o,index:i}));
  if(settings.shuffleO && !q.optionsShuffled){shuffle(q.shuffledOptions);q.optionsShuffled=true;}
  q.shuffledOptions.forEach((o,pos)=>{
    const li=document.createElement('li');
    li.className='option';
    const input=document.createElement('input');
    input.type=multi?'checkbox':'radio';
    input.name='option';
    input.value=o.index;
    input.id='opt'+pos;
    input.checked=(q.selected||[]).includes(o.index);
    const label=document.createElement('label');
    label.setAttribute('for','opt'+pos);
    label.textContent=o.text;
    li.appendChild(input);li.appendChild(label);
    li.setAttribute('tabindex','0');
    li.setAttribute('role',multi?'checkbox':'radio');
    li.setAttribute('aria-checked',input.checked);
    li.addEventListener('click',()=>{input.click();});
    input.addEventListener('change',()=>{
      const sel=q.selected||[];
        if(multi){
          if(input.checked){if(!sel.includes(o.index)) sel.push(o.index);} else {const p=sel.indexOf(o.index); if(p>-1) sel.splice(p,1);}
        }else{
        sel.length=0;if(input.checked) sel.push(o.index);
        document.querySelectorAll('input[name="option"]').forEach(r=>{if(r!==input) r.checked=false;});
      }
        q.selected=sel;li.setAttribute('aria-checked',input.checked);saveState();if(settings.autoSubmit && !multi) submit();
      });
    list.appendChild(li);
  });
    list.querySelector('li')?.focus();
    document.getElementById('feedback').textContent='';
  document.getElementById('explanation').classList.add('hidden');
  updateProgress();
  updateScore();
  document.getElementById('submitBtn').disabled=!!q.answered;
  document.getElementById('nextBtn').classList.toggle('hidden',!q.answered);
}
function updateProgress(){
  const pct=(current)/questions.length*100;
  document.querySelector('#progressBar div').style.width=pct+'%';
  document.getElementById('progressText').textContent=`Question ${current+1} of ${questions.length}`;
}
function updateScore(){
  score=results.filter(r=>r.isCorrect).length;
  const pct=questions.length?Math.round(score/questions.length*100):0;
  document.getElementById('score').textContent=`${score}/${questions.length} (${pct}%)`;
}

function submit(){
  const q=questions[current];
  if(q.answered) return;
  const sel=q.selected||[];
  sel.sort((a,b)=>a-b);
  const correct=JSON.stringify(sel)===JSON.stringify(q.correct);
  q.answered=true;
  q.timeTaken=(q.timeTaken||0)+((Date.now()-q.timeStart)/1000);
  results[current]={index:current,selected:[...sel],isCorrect:correct};
  document.getElementById('feedback').textContent=correct?'Correct':'Incorrect';
  const options=document.querySelectorAll('#options .option');
  options.forEach(opt=>{
    const val=parseInt(opt.querySelector('input').value);
    if(q.correct.includes(val)) opt.classList.add('correct');
    if(sel.includes(val)&&!q.correct.includes(val)) opt.classList.add('incorrect');
  });
  const exp=document.getElementById('explanation');
  exp.textContent=q.explanation||'';exp.classList.remove('hidden');
  document.getElementById('submitBtn').disabled=true;
  document.getElementById('nextBtn').classList.remove('hidden');
  updateScore();
  saveState();
}
function next(){
  if(current<questions.length-1){current++;render();saveState();}
  else finish();
}
  function finish(){
    const correctCount=results.filter(r=>r.isCorrect).length;
    const flagged=questions.filter(q=>q.flagged).length;
    clearInterval(timerInterval);
    document.getElementById('resultSummary').textContent=`Score ${correctCount} / ${questions.length} in ${formatTime(elapsed)}. Flagged ${flagged}`;
    const list=document.getElementById('resultList');
    list.innerHTML='';
    questions.forEach((q,i)=>{
      const li=document.createElement('li');
      const sel=(results[i]?.selected||[]).map(n=>String.fromCharCode(65+n)).join('')||'‚Äî';
      const ans=q.correct.map(n=>String.fromCharCode(65+n)).join('');
      const raw=Array.isArray(q.rawAnswer)?q.rawAnswer.join(' '):(q.rawAnswer||'');
      li.textContent=`${q.question} ‚Äî Your: ${sel} | Correct: ${ans}${raw?` (Orig: ${raw})`:''}`;
      li.className=results[i]?.isCorrect?'correct':'incorrect';
      list.appendChild(li);
    });
    // ----- Analytics -----
    const analytics=document.getElementById('analytics');
    analytics.innerHTML='';
    const avg=questions.reduce((s,q)=>s+(q.timeTaken||0),0)/questions.length;
    const avgP=document.createElement('p');
    avgP.textContent=`Average time/question: ${avg.toFixed(1)}s`;
    analytics.appendChild(avgP);
    const tagStats={};
    questions.forEach((q,i)=>{
      const tg=(q.tags&&q.tags.length)?q.tags:['(none)'];
      tg.forEach(t=>{
        if(!tagStats[t]) tagStats[t]={total:0,correct:0};
        tagStats[t].total++;
        if(results[i]?.isCorrect) tagStats[t].correct++;
      });
    });
    if(Object.keys(tagStats).length){
      const ul=document.createElement('ul');
      ul.innerHTML='<strong>Accuracy by tag</strong>';
      Object.entries(tagStats).forEach(([tag,stat])=>{
        const li=document.createElement('li');
        li.textContent=`${tag}: ${Math.round(stat.correct/stat.total*100)}% (${stat.correct}/${stat.total})`;
        ul.appendChild(li);
      });
      analytics.appendChild(ul);
    }
    const diff=questions.map((q,i)=>({text:q.question,time:q.timeTaken||0,correct:results[i]?.isCorrect}));
    diff.sort((a,b)=>{
      if(a.correct===b.correct) return b.time-a.time;
      return a.correct?1:-1;
    });
    if(diff.length){
      const ol=document.createElement('ol');
      const title=document.createElement('strong');
      title.textContent='Hardest questions';
      analytics.appendChild(title);
      diff.slice(0,3).forEach(d=>{
        const li=document.createElement('li');
        li.textContent=`${d.text} (${d.correct?'correct':'incorrect'}, ${d.time.toFixed(1)}s)`;
        ol.appendChild(li);
      });
      analytics.appendChild(ol);
    }
    document.getElementById('resultModal').style.display='flex';
    saveState();
  }
  function retryIncorrect(){
    const incorrect=questions.filter((q,i)=>!results[i]||!results[i].isCorrect);
    if(!incorrect.length){document.getElementById('resultModal').style.display='none';return;}
    document.getElementById('resultModal').style.display='none';
    startQuiz(incorrect);
  }

  function reviewFlagged(){
    const flagged=questions.filter(q=>q.flagged);
    if(!flagged.length){document.getElementById('resultModal').style.display='none';return;}
    document.getElementById('resultModal').style.display='none';
    startQuiz(flagged);
  }

/* ---------- File Handling ---------- */
async function handleFile(file){
  try{
    const ext=file.name.split('.').pop().toLowerCase();
    const qs=ext==='csv'?await parseCSV(file):await parseJSON(file);
    startQuiz(qs);
  }catch(err){alert('Import error: '+err.message);}
}
function startQuiz(qs){
  allQuestions=qs.map(q=>Object.assign({flagged:false},q));
  settings.tag='';
  document.getElementById('tagFilter').value='';
  updateTagOptions();
  applyTagFilter();
}

/* ---------- Export / Import State ---------- */
function exportResults(){
  if(!results.length) return;
  let csv='Question,YourAnswer,Correct,Explanation,Tags\n';
  questions.forEach((q,i)=>{
    const sel=(q.selected||[]).map(n=>String.fromCharCode(65+n)).join('');
    const ans=q.correct.map(n=>String.fromCharCode(65+n)).join('');
    const tags=(q.tags||[]).join('|');
    csv+=`"${q.question.replace(/"/g,'""')}",${sel},${ans},"${(q.explanation||'').replace(/"/g,'""')}","${tags}"\n`;
  });
  download(csv,'results.csv');
}
function exportState(){
  saveState();
  download(localStorage.getItem(STORAGE_KEY)||'','mcq-state.json');
}
function importStateFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{localStorage.setItem(STORAGE_KEY,e.target.result);loadState();render();}
    catch(err){alert('Invalid state file');}
  };
  reader.readAsText(file);
}

/* ---------- Event Bindings ---------- */
document.getElementById('loadBtn').onclick=()=>document.getElementById('fileInput').click();
window.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT') return;
  const opts=[...document.querySelectorAll('#options input')];
  const num=parseInt(e.key,10);
  if(num>=1&&num<=opts.length){opts[num-1].click();}
  if(e.key==='Enter'){ if(!questions[current].answered) submit(); else next(); }
});
document.getElementById('fileInput').addEventListener('change',e=>{const file=e.target.files[0];if(file)handleFile(file);});

document.getElementById('submitBtn').onclick=submit;
document.getElementById('nextBtn').onclick=next;
document.getElementById('restartBtn').onclick=()=>{if(confirm('Clear progress?')){resetState();loadSample();}};
document.getElementById('exportBtn').onclick=exportResults;
document.getElementById('darkToggle').onclick=()=>{document.body.classList.toggle('dark');settings.dark=document.body.classList.contains('dark');saveState();};
document.getElementById('retryBtn').onclick=retryIncorrect;
document.getElementById('flaggedBtn').onclick=reviewFlagged;
document.getElementById('closeResult').onclick=()=>document.getElementById('resultModal').style.display='none';
document.getElementById('exportStateBtn').onclick=exportState;
document.getElementById('importStateBtn').onclick=()=>document.getElementById('importState').click();
document.getElementById('importState').addEventListener('change',e=>{const f=e.target.files[0];if(f)importStateFile(f);});
document.getElementById('flagBtn').onclick=()=>{const q=questions[current];q.flagged=!q.flagged;render();saveState();};
document.getElementById('tagEditBtn').onclick=editTags;
document.getElementById('tagFilter').addEventListener('change',applyTagFilter);
document.getElementById('searchBox').addEventListener('keydown',e=>{if(e.key==='Enter'){const term=e.target.value.trim().toLowerCase();if(!term)return;const i=questions.findIndex(q=>q.question.toLowerCase().includes(term));if(i>=0){current=i;render();saveState();}else alert('No match');}});
document.getElementById('timeLimit').addEventListener('change',e=>{settings.timeLimit=parseInt(e.target.value)||0;saveState();});

document.getElementById('shuffleQ').addEventListener('change',e=>{settings.shuffleQ=e.target.checked;saveState();});
document.getElementById('shuffleO').addEventListener('change',e=>{settings.shuffleO=e.target.checked;saveState();});
document.getElementById('autoSubmit').addEventListener('change',e=>{settings.autoSubmit=e.target.checked;saveState();});

/* ---------- Sample Data ---------- */
function loadSample(){
  const sampleJSON=document.getElementById('sample-json').textContent;
  const raw=JSON.parse(sampleJSON);
  const qs=raw.map((o,i)=>({
    id:o.id||i+1,
    question:o.question,
    options:o.options,
    correct:normalizeAnswers(o.answer,o.options.length,true),
    explanation:o.explanation||'',
    rawAnswer:o.answer,
    tags:o.tags||[]
  }));
  startQuiz(qs);
}

/* ---------- Init ---------- */
if(!loadState()){
  // if no previous state, load sample csv
  loadSample();
}else{
  render();
  if(results.length<questions.length) startTimer(); else document.getElementById('timer').textContent=formatTime(elapsed);
}
// prepare downloadable sample CSV
const sampleCsv=document.getElementById('sample-csv').textContent;
const link=document.getElementById('sampleCsvLink');
link.href=URL.createObjectURL(new Blob([sampleCsv],{type:'text/csv'}));
link.textContent='Download sample CSV';
link.classList.remove('hidden');

})();
</script>

<script id="sample-json" type="application/json">[
  {
    "question":"What is the capital of France?",
    "options":["Paris","London","Berlin","Madrid"],
    "answer":0,
    "explanation":"Paris is the capital of France.",
    "tags":["geography"]
  },
  {
    "question":"Which planet is known as the Red Planet?",
    "options":["Earth","Venus","Mars","Jupiter"],
    "answer":2,
    "explanation":"The iron oxide on Mars gives it a reddish appearance.",
    "tags":["space"]
  },
  {
    "question":"Which of the following are prime numbers?",
    "options":["2","3","4","5"],
    "answer":[0,1,3],
    "explanation":"2, 3 and 5 are prime numbers.",
    "tags":["math"]
  }
]</script>
</script>

<script id="sample-csv" type="text/plain">Question,Option A,Option B,Option C,Option D,Correct Answer,Explanation,Tags
What is the capital of France?,Paris,London,Berlin,Madrid,A,Paris is the capital of France.,geography
Which planet is known as the Red Planet?,Earth,Venus,Mars,Jupiter,C,The iron oxide on Mars gives it a reddish appearance.,space
Which of the following are prime numbers?,2,3,4,5,A;B;D,2, 3 and 5 are prime numbers.,math
</script>

</body>
</html>
